<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>js-sequence-diagram | Basic demo</title>
    <style type="text/css">
        #diagram {
            overflow: visible;
            display: inline-block;
        }
    </style>
    <script type="text/javascript" src="https://unpkg.com/jquery@latest/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/raphael@latest/raphael.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/underscore@latest/underscore-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/html2canvas@latest/dist/html2canvas.min.js"></script>
</head>
<body>
<input type="file" id="file-input" style='width:100%'/>
<button id="to-img">To image</button>
<div id="diagram"></div>
<script type="module">
    import {readSingleFile} from "./scripts/functions.js";

    const div = document.querySelector("#diagram");
    $('#to-img').click(() => {
        html2canvas(div).then(canvas => {
            let link = document.createElement('a');
            link.download = 'sequence-diagram.jpeg';
            link.href = canvas.toDataURL();
            link.click();
        });
    })

    function displayContents(contents) {
        let parsedData = Papa.parse(contents).data.slice(1, 1300);
        let diagram = 'Title: Wizualizacja przelewÃ³w bankowych\n';
        let names = [];
        parsedData.forEach(row => {
            names.push(row[4]);
            names.push(row[7]);
        });
        let uniqueNamesLimited = [...new Set(names)].slice(0, 15);
        uniqueNamesLimited.forEach(name => diagram += `participant ${name}\n`);
        let date = '';
        parsedData.forEach(row => {
            if (uniqueNamesLimited.includes(row[4]) && uniqueNamesLimited.includes(row[7])) {
                if (date !== row[1]) {
                    date = row[1];
                    diagram += `Note left of ${uniqueNamesLimited[0]}: ${date}\n`;
                }
                diagram += `${row[4]}->${row[7]}: ${row[8]}\n`;
            }
        });
        let d = Diagram.parse(diagram);
        let options = {theme: 'simple'};
        d.drawSVG('diagram', options);
    }

    document.getElementById('file-input')
        .addEventListener('change', e => readSingleFile(e, displayContents), false);
</script>
</body>
</html>